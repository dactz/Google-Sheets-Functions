// Function to fetch email from a GitHub profile URL using the GitHub API
function getGitHubEmail(gitHubUrl) {
  const baseApiUrl = "https://api.github.com";
  const token = "YOUR_GITHUB_PERSONAL_ACCESS_TOKEN"; // Optional: Add a personal access token here if rate-limiting becomes an issue

  try {
    // Extract the GitHub username from the provided URL
    const match = gitHubUrl.match(/^https:\/\/github\.com\/([^\/]+)/);
    if (!match) {
      return "Invalid GitHub URL";
    }
    const username = match[1];
    
    // Step 1: Fetch public repositories for the user
    const repoUrl = `${baseApiUrl}/users/${username}/repos`;
    const repoResponse = UrlFetchApp.fetch(repoUrl, {
      headers: {
        Authorization: `token ${token}`,
        Accept: "application/vnd.github.v3+json"
      },
      muteHttpExceptions: true
    });

    if (repoResponse.getResponseCode() !== 200) {
      return `Error fetching repositories: ${repoResponse.getContentText()}`;
    }

    const repos = JSON.parse(repoResponse.getContentText());

    // Step 2: Loop through each repository to find the latest commit
    for (const repo of repos) {
      const commitsUrl = `${repo.commits_url.replace('{/sha}', '')}?per_page=1`;
      const commitResponse = UrlFetchApp.fetch(commitsUrl, {
        headers: {
          Authorization: `token ${token}`,
          Accept: "application/vnd.github.v3+json"
        },
        muteHttpExceptions: true
      });

      if (commitResponse.getResponseCode() !== 200) {
        continue; // Skip this repository if there's an issue fetching the commits
      }

      const commits = JSON.parse(commitResponse.getContentText());
      if (commits.length > 0) {
        const commit = commits[0];
        const email = commit.commit.author.email;

        // Exclude GitHub's noreply emails
        if (!email.includes("noreply.github.com")) {
          return email;
        }
      }
    }

    return "No email found";

  } catch (error) {
    return `Error: ${error.message}`;
  }
}
